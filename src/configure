#!/bin/sh

# Copyright (c) 2020, NVIDIA CORPORATION. All rights reserved.
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the "Software"),
# to deal in the Software without restriction, including without limitation
# the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom the
# Software is furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in 
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
# DEALINGS IN THE SOFTWARE.

rm -rf build
_KVER=$1
TMPDIR1=build
MAKEFILE="${TMPDIR1}/Makefile"
TEST_H="${TMPDIR1}/test.h"
TEST_C="${TMPDIR1}/test.c"

mkdir -p $TMPDIR1

config_host_h=config-host.h

rm -rf $config_host_h

remove_test() {
   make clean >> config.log 2>&1
   cd ..
   truncate -s 0 $TEST_C
}

output_sym() {
  echo "#define $1 1" >> $config_host_h
}

fatal() {
  echo $@
  echo "Configure failed, check config.log and/or the above output"
  rm -rf $config_host_h
  exit 1
}

compile_prog() {
   cd ${TMPDIR1}
   echo $1 '\n' >> config.log
   make >> config.log 2>&1
   ret=$?
   if [ "$ret" -eq 0 ]
   then
        echo '\n' $1 "yes" >> config.log
	echo $1 "yes"
	echo '\n' "Invoking make clean" >> config.log
        remove_test
        return 0	
   else
        echo '\n' $1 "no"  >> config.log
        echo $1 "no"
	echo '\n' "Invoking make clean" >> config.log
        remove_test
	return 1
   fi
}

echo "/*" > $config_host_h
echo " * Automatically generated by configure - do not modify" >> $config_host_h
printf " * Configured with:" >> $config_host_h
printf " * '%s'" "$0" "$@" >> $config_host_h
echo "" >> $config_host_h
echo " */" >> $config_host_h

echo "#ifndef CONFIG_HOST_H" >> $config_host_h
echo "#define CONFIG_HOST_H" >> $config_host_h

#Check if KVER is already passed, if not assign the current kernel version
if [ -z "$_KVER" ]
then
	export KVER=$(uname -r)
else
	export KVER=${_KVER}
fi
export MODULES_DIR=/lib/modules/$KVER
export KDIR=$MODULES_DIR/build

cat > $MAKEFILE <<EOF
obj-m += test.o
all:
	make -j8 -C $KDIR M=$PWD/build modules
clean:
	make -j8 -C $KDIR M=$PWD/build clean
EOF

cat > $TEST_H <<EOF
#include <linux/module.h>
#include <linux/kernel.h>

MODULE_LICENSE("GPL v2");
EOF

cat > $TEST_C <<EOF


#include <linux/uaccess.h>
#include "test.h"

int test (void)
{
        access_ok(VERIFY_READ, NULL, 0);
        access_ok(VERIFY_WRITE, NULL, 0);
        return 0;
}

EOF
if compile_prog "checking if uaccess.h access_ok has 3 parameters..."; then
        output_sym "HAVE_ACCESS_OK_3_PARAMS"
fi

cat > $TEST_C <<EOF
#include <linux/uaccess.h>
#include "test.h"

int test (void)
{
        access_ok(NULL, 0);
        return 0;
}

EOF
if compile_prog "checking if uaccess.h access_ok has 2 parameters..."; then
        output_sym "HAVE_ACCESS_OK_2_PARAMS"
fi

cat > $TEST_C <<EOF
#include <linux/blkdev.h>
#include "test.h"

int test (void)
{
	blk_rq_payload_bytes(NULL);
	return 0;
}

EOF
if compile_prog "Checking if blkdev.h has blk_rq_payload_bytes..."; then
	output_sym "HAVE_BLK_RQ_PAYLOAD_BYTES"
fi

cat > $TEST_C <<EOF
#include <linux/fs.h>
#include "test.h"

int test (void)
{

                call_read_iter(NULL, NULL, NULL);
                call_write_iter(NULL, NULL, NULL);
                return 0;
}

EOF
if compile_prog "Checking if fs.h has call_read_iter and call_write_iter..."; then
        output_sym "HAVE_CALL_READ_WRITE_ITER"
fi

cat > $TEST_C <<EOF
#include <linux/fs.h>
#include "test.h"

int test (void)
{
        filemap_range_has_page(NULL, 0, 0);
        return 0;
}

EOF
if compile_prog "Checking if fs.h has filemap_range_has_page..."; then
        output_sym "HAVE_FILEMAP_RANGE_HAS_PAGE"
fi

cat > $TEST_C <<EOF
#include <linux/security.h>
#include <linux/fs.h>
#include "test.h"

int test (void)
{
        security_file_permission(NULL, MAY_READ);
        security_file_permission(NULL, MAY_WRITE);
        return 0;
}

EOF
if grep -w "__kstrtab_security_file_permission" /boot/System.map-${KVER} >> /dev/null 2>&1 && \
	compile_prog "Checking if security_file_permission API exist..."; then
        output_sym "HAVE_SECURITY_FILE_PERMISSION"
fi

cat > $TEST_C <<EOF
#include <linux/fs.h>
#include "test.h"

int test (void)
{
        struct kiocb iocb;
        iocb.ki_complete = NULL;

        return 0;
}
EOF
if compile_prog "Checking if kiocb structue has ki_complete field... "; then
        output_sym "HAVE_KI_COMPLETE"
fi

cat > $TEST_C <<EOF
#include <linux/mm_types.h>
#include "test.h"

int test (void)
{
        vm_fault_t a;

        return 0;
}
EOF
if compile_prog "Checking if vm_fault_t exist in mm_types.h... "; then
        output_sym "HAVE_VM_FAULT"
fi

cat > $TEST_C <<EOF
#include <linux/fs.h>
#include "test.h"

int test (void)
{
        int x = IOCB_HIPRI;

        return 0;
}
EOF
if compile_prog "Checking if IOCB_HIPRI flag exists in fs.h... "; then
        output_sym "HAVE_IOCB_HIPRI"
fi

cat > $TEST_C <<EOF
#include <linux/pci.h>
#include "test.h"

int test (void)
{
        int x = PCIE_SPEED_32_0GT;

        return 0;
}
EOF
if compile_prog "Checking if enum PCIE_SPEED_32_0GT exists in pci.h... "; then
        output_sym "HAVE_PCIE_SPEED_32_0GT"
fi

echo "#endif" >> $config_host_h
rm -rf build
